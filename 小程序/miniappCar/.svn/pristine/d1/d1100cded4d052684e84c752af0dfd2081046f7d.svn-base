import Taro, { Component } from "@tarojs/taro";
import { View, Button } from "@tarojs/components";
import { connect } from "@tarojs/redux";
//组件 - baiduMap
import BaiduMap from "../../components/baiduMap/main";

// 功能 -websocket
import webSocket from "../../components/webSocket";

import "./index.scss";

@connect(({ userInfo, car }) => ({
  userInfo,
  car
}))
export default class Index extends Component {
  constructor(props) {
    super(props);

    this.state = {
      showSiderMenu: false
    };
  }

  componentDidMount = () => {
    let that = this;
    //TODO:这个方法后续不维护,待优化
    wx.getUserInfo({
      success: function(res) {
        that.props.dispatch({
          type: "userInfo/saveUserInfo",
          response: {
            weixinUserInfo: res.userInfo
          }
        });
      }
    });
    Taro.showLoading({
      title: "加载中..."
    });
  };

  render() {
    const { UserID } = this.props.userInfo.carUserInfo;
    const { carStateList } = this.props.car;

    //TODO:放在这里可能会多次调用,后期优化
    if (!!UserID && carStateList.length == 0) {
      this.props.dispatch({
        type: "car/getCarLastState",
        payload: {
          UserId: UserID
        }
      });
    }
    return (
      <View
        className={["index-wrap"]}
        style={{ opacity: carStateList.length == 0 ? "0" : "1" }}
      >
        <View className="map-wrap">
          <BaiduMap isShow={this.state.showSiderMenu} />
        </View>
      </View>
    );
  }
}
