import Taro, { Component } from "@tarojs/taro";
import { connect } from "@tarojs/redux";
import { View, Map, CoverView, CoverImage } from "@tarojs/components";
// 组件 - 侧边菜单
import SiderMenu from "../../components/siderMenu";
import MarkerInfoWindow from "./markerInfo";
import headerIcon from "../../images/index_header_icon.png";
import reloadIcon from "../../images/index_map_reload_icon.png";
import "./main.scss";

@connect(({ car, menu }) => ({
  car,
  menu
}))
export default class MapMain extends Component {
  constructor(props) {
    super(props);
    console.log(props);

    this.state = {
      latitude: "23.099994",
      longitude: "113.324520",
      showMarkerInfo: false,
      markerInfo: {} //弹窗信息
    };
    this.handleMenu = this.handleMenu.bind(this);
    this.handleMakertap = this.handleMakertap.bind(this);
    this.handleReloadBtn = this.handleReloadBtn.bind(this);
    this.handleMap = this.handleMap.bind(this);
  }
  getLocation = () => {
    wx.getLocation({
      success: res => {
        this.setState({
          longitude: res.longitude,
          latitude: res.latitude,
          controls: []
        });
        // this.mapCtx.moveToLocation();
      }
    });
  };
  componentDidMount() {
    this.getLocation();
  }
  handleMakertap = e => {
    let { carStateList } = this.props.car;
    let info = {};
    carStateList.forEach(item => {
      if (item.id == e.markerId) {
        info = item;
        return;
      }
    });

    this.setState({
      showMarkerInfo: true,
      markerInfo: info
    });
  };
  handleReloadBtn = () => {
    this.setState({
      latitude: 0,
      longitude: 0
    });
    this.getLocation();
  };
  handleMap = () => {
    this.setState({
      showMarkerInfo: false,
      markerInfo: {}
    });
  };
  handleMenu = () => {
    const { isShow } = this.props.menu;
    this.props.dispatch({
      type: "menu/saveState",
      response: {
        isShow: !isShow
      }
    });
  };
  render() {
    const { carStateList } = this.props.car;
    const { isShow } = this.props.menu;
    // const type = this.props;
    // console.log(this.props);

    return (
      <View class="map_container">
        <Map
          id="myMap"
          longitude={this.state.longitude}
          latitude={this.state.latitude}
          include-points={carStateList}
          markers={carStateList}
          onMarkertap={this.handleMakertap}
          onClick={this.handleMap}
          style="width: 100%; height: 100%;"
        >
          {/* 遮罩层 */}
          {/* {!!isShow && <CoverView class="mask" onTap={this.handleMenu} />} */}
          {/* {marker信息} */}
          {
            <MarkerInfoWindow
              isShow={this.state.showMarkerInfo}
              info={this.state.markerInfo}
            />
          }

          {/* 定位按钮 */}
          <CoverImage
            class="reload-btn"
            src={reloadIcon}
            onTap={this.handleReloadBtn}
          />
          {/* {头部按钮} */}
          <CoverImage
            class="header-btn"
            src={headerIcon}
            onTap={this.handleMenu}
          />
          <SiderMenu />
        </Map>
      </View>
    );
  }
}
