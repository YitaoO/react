import "@tarojs/async-await";
import Taro, { Component } from "@tarojs/taro";
import Index from "./pages/index";
import Map from "./components/baiduMap/main";
import dva from "./dva";
import models from "./model";
import { Provider } from "@tarojs/redux";
import wxTools from "./components/tools/wx_tools";
import "./app.scss";

const dvaApp = dva.createApp({
  initialState: {},
  models: models,
  onError(e, dispatch) {
    dispatch({
      type: "sys/error",
      e
    });
  }
});

const store = dvaApp.getStore();

class App extends Component {
  constructor(props) {
    super(props);
  }
  config = {
    pages: [
      "pages/index/index", //首页
      "pages/history/index", //历史轨迹-主页
      "pages/registration/index", //注册页
      "pages/traceDetail/index", //轨迹详情
      "pages/choiceCar/index" //选择车辆
    ],
    window: {
      backgroundTextStyle: "light",
      navigationBarBackgroundColor: "#58bdf2",
      navigationBarTitleText: "设备动态管理",
      navigationBarTextStyle: "white",
      enablePullDownRefresh: true
    }
  };
  componentWillMount() {}

  componentDidMount() {
    // 获取openId
    wxTools.addCloud();

    wxTools.getOpenId().then(function(res) {
      dvaApp.dispatch({
        type: "userInfo/saveOpenId",
        openId: res.openid
      });
      dvaApp.dispatch({
        type: "userInfo/login",
        payload: {
          openID: res.openid,
          weixin: "weixin"
        }
      });
    });
    //测试，到时去掉
    // dvaApp.dispatch({
    //   type: "userInfo/login",
    //   payload: {
    //     // openID: res.openid,
    //     weixin: "weixin"
    //   }
    // });
  }

  componentDidShow() {}

  componentDidHide() {}

  componentCatchError() {}

  render() {
    return (
      <Provider store={store}>
        <Index />
        {/* <Map /> */}
      </Provider>
    );
  }
}

Taro.render(<App />, document.getElementById("app"));
