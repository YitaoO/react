import Taro from "@tarojs/taro";
import {
  reqCarStateList,
  reqListTreeCar,
  reqCarAccInfo,
  reqCarTrance
} from "../services/api";
import carOn from "../images/index_car_on_icon.png";
import carOff from "../images/index_car_off_icon.png";

export default {
  namespace: "car",
  state: {
    carStateList: [], //车辆最新状态
    listTreeCar: [], //车辆树
    choiceCar: null, //选中的车辆
    carGuijiList: {
      page: 1,
      limit: 20,
      list: []
    }, //轨迹
    carGuijiDetail: [] //轨迹详情
  },
  reducers: {
    saveCar(state, payload) {
      return {
        ...state,
        ...payload.response
      };
    }
  },
  effects: {
    // 车辆最新状态
    *getCarLastState({ payload }, { call, put }) {
      let response = yield call(reqCarStateList, payload);
      Taro.hideLoading();
      response.forEach(item => {
        item.id = item.simno;
        item.width = 61;
        item.height = 61;
        item.iconPath = !!item.acc ? carOn : carOff;
        // item.callout = {
        //   display: "none",
        //   content: `<view>${item.carModel}\n${item.carModel}</view>`,
        //   bgColor: "#ffffff",
        //   padding: 15
        // };
      });

      yield put({
        type: "saveCar",
        response: {
          carStateList: response
        }
      });
    },
    // 获取车辆树
    *getCarTree({ payload }, { call, put }) {
      let response = yield call(reqListTreeCar, payload);
      Taro.hideLoading();
      yield put({
        type: "saveCar",
        response: {
          listTreeCar: response
        }
      });
    },
    // 获取行驶统计
    *getCarList({ payload }, { call, put }) {
      const { page, limit } = payload;
      const response = yield call(reqCarAccInfo, payload);

      yield put({
        type: "saveCar",
        response: {
          carGuijiList: {
            list: response,
            page: page,
            limit: limit
          }
        }
      });
    },

    // 获取轨迹详情
    *getCarTrance({ payload }, { call, put }) {
      const response = yield call(reqCarTrance, payload);
      yield put({
        type: "saveCar",
        response: {
          carGuijiDetail: response.data
        }
      });
    }
  }
};
