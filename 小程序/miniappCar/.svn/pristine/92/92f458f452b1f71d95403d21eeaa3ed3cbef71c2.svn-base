import Taro, { Component } from "@tarojs/taro";
import { create } from "dva-core";
import { connect } from "@tarojs/redux";
import { View, Map, CoverView } from "@tarojs/components";
import "./index.scss";
const MapWX = require("./qqmap-wx-jssdk.min.js");

@connect(({ car }) => ({
  car
}))
export default class Index extends Component {
  constructor(props) {
    super(props);
    this.state = {
      latitude: "23.099994",
      longitude: "113.324520",
      showMarkerInfo: false,
      markerInfo: {} //弹窗信息
    };
    this.handleMakertap = this.handleMakertap.bind(this);
    this.handleReloadBtn = this.handleReloadBtn.bind(this);
  }
  getLocation = () => {
    wx.getLocation({
      success: res => {
        this.setState({
          longitude: res.longitude,
          latitude: res.latitude
        });
        // this.mapCtx.moveToLocation();
      }
    });
  };
  componentDidMount() {
    // 初始化地图
    // this.mapCtx = wx.createMapContext("myMap");

    this.getLocation();
  }
  handleMakertap = e => {
    let { carStateList } = this.props.car;
    let info = {};
    carStateList.forEach(item => {
      if (item.id == e.markerId) {
        info = item;
        return;
      }
    });
    console.log(info);
    this.setState({
      markerInfo: info
    });
  };
  handleReloadBtn = () => {
    this.setState({
      latitude: 0,
      longitude: 0
    });
    this.getLocation();
  };
  render() {
    let { carStateList } = this.props.car;

    return (
      <View class="map_container">
        <Map
          id="myMap"
          longitude={this.state.longitude}
          latitude={this.state.latitude}
          include-points={carStateList}
          markers={carStateList}
          onMarkertap={this.handleMakertap}
          style="width: 100%; height: 100%;"
        >
          <cover-view
            class="marker-info"
            style={{ opacity: !!this.state.markerInfo ? "0" : "1" }}
          >
            <cover-view class="center">
              <cover-view class="item">
                <cover-view class="left">
                  <cover-view class="title">车牌号</cover-view>
                  <cover-view class="value">粤ABX028</cover-view>
                </cover-view>
                <cover-view class="right">
                  <cover-view class="title">类型</cover-view>
                  <cover-view class="value">洒水车</cover-view>
                </cover-view>
              </cover-view>
              <cover-view class="item">
                <cover-view class="left">
                  <cover-view class="title">速度</cover-view>
                  <cover-view class="value">0.1 km/h</cover-view>
                </cover-view>
                <cover-view class="right">
                  <cover-view class="title">熄火</cover-view>
                  <cover-view class="value">3h 48min</cover-view>
                </cover-view>
              </cover-view>
              <cover-view class="item">
                <cover-view class="left">
                  <cover-view class="title">司机</cover-view>
                  <cover-view class="value">张晓斌</cover-view>
                </cover-view>
                <cover-view class="right">
                  <cover-view class="title">电话</cover-view>
                  <cover-view class="value">13566789879</cover-view>
                </cover-view>
              </cover-view>
              <cover-view class="item">
                <cover-view class="left">
                  <cover-view class="title">车牌号</cover-view>
                  <cover-view class="value">粤ABX028</cover-view>
                </cover-view>
                <cover-view class="right">
                  <cover-view class="title">标题</cover-view>
                  <cover-view class="value">值</cover-view>
                </cover-view>
              </cover-view>
            </cover-view>

            <cover-view className="footer">底部</cover-view>
          </cover-view>
        </Map>
        <View className="reload-btn" onClick={this.handleReloadBtn} />
      </View>
    );
  }
}
